<% layout("layouts/boilerplate") %>

    <style>
        /* Main Container */
        #filters-main {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1rem 0;
            position: sticky;
            top: 4.8rem;
            z-index: 90;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Left Side: Categories */
        #filters {
            display: flex;
            align-items: center;
            overflow-x: auto;
            white-space: nowrap;
            flex-grow: 1;
            margin-right: 1rem;
            padding-left: 1rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #filters::-webkit-scrollbar {
            display: none;
        }

        .filter {
            text-align: center;
            margin-right: 2rem;
            opacity: 0.6;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
            padding-bottom: 0.25rem;
        }

        .filter:hover {
            opacity: 1;
            border-bottom-color: #222;
        }

        .filter p {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0;
            color: #222;
        }

        .filter i {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            color: #444;
            transition: transform 0.2s;
        }

        .filter:hover i {
            transform: scale(1.1);
        }

        .filter a {
            text-decoration: none;
            color: inherit;
        }

        /* Right Side: Tax Toggle */
        .tax-toggle {
            border: 1px solid #e0e0e0;
            border-radius: 50px;
            height: 3rem;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-right: 1rem;
            transition: all 0.3s ease;
        }

        .tax-toggle:hover {
            border-color: #b0b0b0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .tax-info {
            display: none;
        }

        .form-check-label {
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
        }

        /* Wishlist Heart Button Styles */
        .wishlist-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 100;
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: white;
            /* Default empty state color */
            transition: transform 0.2s;
        }

        .wishlist-btn:hover {
            transform: scale(1.2);
            cursor: pointer;
        }

        .wishlist-btn .fa-heart {
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
            /* Shadow makes it visible on light images */
        }

        /* Style for active (liked) state */
        .wishlist-btn.active {
            color: #fe424d;
            /* Airbnb red */
            opacity: 1;
        }
    </style>

    <div id="filters-main">
        <div id="filters">
            <div class="filter"><a href="/listings?category=trending">
                    <div><i class="fa-solid fa-fire"></i></div>
                    <p>Trending</p>
                </a></div>
            <div class="filter"><a href="/listings?category=rooms">
                    <div><i class="fa-solid fa-bed"></i></div>
                    <p>Rooms</p>
                </a></div>
            <div class="filter"><a href="/listings?category=iconic-cities">
                    <div><i class="fa-solid fa-mountain-city"></i></div>
                    <p>Iconic Cities</p>
                </a></div>
            <div class="filter"><a href="/listings?category=mountains">
                    <div><i class="fa-solid fa-mountain"></i></div>
                    <p>Mountains</p>
                </a></div>
            <div class="filter"><a href="/listings?category=castles">
                    <div><i class="fa-brands fa-fort-awesome"></i></div>
                    <p>Castles</p>
                </a></div>
            <div class="filter"><a href="/listings?category=amazing-pools">
                    <div><i class="fa-solid fa-person-swimming"></i></div>
                    <p>Pools</p>
                </a></div>
            <div class="filter"><a href="/listings?category=camping">
                    <div><i class="fa-solid fa-campground"></i></div>
                    <p>Camping</p>
                </a></div>
            <div class="filter"><a href="/listings?category=farms">
                    <div><i class="fa-solid fa-cow"></i></div>
                    <p>Farms</p>
                </a></div>
            <div class="filter"><a href="/listings?category=arctic">
                    <div><i class="fa-regular fa-snowflake"></i></div>
                    <p>Arctic</p>
                </a></div>
            <div class="filter"><a href="/listings?category=domes">
                    <div><i class="fa-solid fa-igloo"></i></div>
                    <p>Domes</p>
                </a></div>
            <div class="filter"><a href="/listings?category=boats">
                    <div><i class="fa-regular fa-sailboat"></i></div>
                    <p>Boats</p>
                </a></div>
        </div>

        <div class="tax-toggle">
            <div class="form-check-reverse form-switch">
                <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
                <label class="form-check-label" for="flexSwitchCheckDefault">Total after taxes</label>
            </div>
        </div>

        <div class="filter-btn">
            <button class="btn btn-outline-dark" type="button" data-bs-toggle="modal" data-bs-target="#filterModal"
                style="border-radius: 50px; height: 3rem; padding: 0 1.2rem; font-size: 0.9rem; margin-right: 1rem; border: 1px solid #e0e0e0;">
                <i class="fa-solid fa-sliders"></i> Filters
            </button>
        </div>
    </div>

    <div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 mt-3">
        <% if(allListings.length===0) { %>
            <div class="col-12 d-flex flex-column align-items-center justify-content-center" style="height: 60vh;">
                <i class="fa-solid fa-face-frown fa-4x mb-4 text-muted"></i>
                <h3 class="fw-bold text-dark">No Listings Found</h3>
                <p class="text-muted mb-4">We couldn't find any matches for your filters.</p>
                <a href="/listings" class="btn btn-danger rounded-pill px-4 py-2">
                    View All Listings
                </a>
            </div>
            <% } else { %>
                <% for(let listing of allListings){ %>
                    <div class="card col listing-card hover-effect position-relative">

                        <% if(currUser) { %>
                            <form action="/wishlist/<%= listing._id %>" method="POST">
                                <% let isLiked=false; if(currUser.wishlist && currUser.wishlist.length> 0) {
                                    // Robust check for ObjectId comparison
                                    isLiked = currUser.wishlist.some(id => id.toString() === listing._id.toString());
                                    }
                                    %>
                                    <button class="wishlist-btn <%= isLiked ? 'active' : '' %>">
                                        <i class="<%= isLiked ? 'fa-solid' : 'fa-regular' %> fa-heart"></i>
                                    </button>
                            </form>
                            <% } %>

                                <a href="/listings/<%= listing._id %>" class="listing-link">
                                    <img src="<%= listing.image.url.replace('/upload/', '/upload/w_800,f_auto,q_auto/') %>"
                                        class="card-img-top" alt="listing_image" style="height: 20rem;" loading="lazy">
                                    <div class="card-img-overlay"></div>
                                    <div class="card-body">
                                        <p class="card-text">
                                            <b>
                                                <%= listing.title %>
                                            </b> <br>
                                            &#8377; <%= listing.price.toLocaleString("en-IN") %> /night
                                                <i class="tax-info"> &nbsp; +18% GST</i>
                                        </p>
                                    </div>
                                </a>
                    </div>
                    <% } %>
                        <% } %>
    </div>

    <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
    <div class="d-flex justify-content-center mt-4 mb-5">
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <% 
                    let params = new URLSearchParams();
                    if(values.search) params.append('search', values.search);
                    if(values.category && values.category !== "undefined") params.append('category', values.category);
                    if(values.min_price) params.append('min_price', values.min_price);
                    if(values.max_price) params.append('max_price', values.max_price);
                    if(values.guests) params.append('guests', values.guests);
                    if(values.checkIn) params.append('checkIn', values.checkIn);
                    if(values.checkOut) params.append('checkOut', values.checkOut);
                    
                    if(values.amenities && values.amenities.length > 0) {
                        values.amenities.forEach(a => params.append('amenities', a));
                    }
                    
                    let queryString = params.toString();
                    let prefix = queryString ? `&${queryString}` : '';
                %>

                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link" href="/listings?page=<%= currentPage - 1 %><%= prefix %>" aria-label="Previous">
                        <span aria-hidden="true">&laquo; Previous</span>
                    </a>
                </li>

                <li class="page-item disabled">
                    <span class="page-link text-muted">Page <%= currentPage %> of <%= totalPages %></span>
                </li>

                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                    <a class="page-link" href="/listings?page=<%= currentPage + 1 %><%= prefix %>" aria-label="Next">
                        <span aria-hidden="true">Next &raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    <% } %>

    <div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Filters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/listings" method="GET">
                    <div class="modal-body">
                        <% if(values && values.search) { %>
                            <input type="hidden" name="search" value="<%= values.search %>">
                            <% } %>
                                <% if(values && values.category && values.category !=="undefined" ) { %>
                                    <input type="hidden" name="category" value="<%= values.category %>">
                                    <% } %>

                                    <h6>Price Range</h6>
                                    <div class="d-flex align-items-center mb-3">
                                        <input type="number" name="min_price" class="form-control me-2"
                                            placeholder="Min" min="0"
                                            value="<%= (values && values.min_price) ? values.min_price : '' %>">
                                        <span>-</span>
                                        <input type="number" name="max_price" class="form-control ms-2"
                                            placeholder="Max" min="0"
                                            value="<%= (values && values.max_price) ? values.max_price : '' %>">
                                    </div>

                                    <h6>Guest Capacity</h6>
                                    <div class="mb-3">
                                        <input type="number" name="guests" class="form-control" placeholder="Any"
                                            min="1" value="<%= (values && values.guests) ? values.guests : '' %>">
                                    </div>

                                    <h6>Amenities</h6>
                                    <div class="row">
                                        <% const filterAmenities=["Wifi", "AC" , "Pool" , "Parking" ]; %>
                                            <% for(let amenity of filterAmenities) { %>
                                                <div class="col-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="amenities" value="<%= amenity %>"
                                                            id="f_<%= amenity %>" <%=(values && values.amenities &&
                                                            values.amenities.includes(amenity)) ? 'checked' : '' %>>
                                                        <label class="form-check-label" for="f_<%= amenity %>">
                                                            <%= amenity %>
                                                        </label>
                                                    </div>
                                                </div>
                                                <% } %>
                                    </div>
                    </div>
                    <div class="modal-footer">
                        <a href="/listings" class="btn btn-secondary">Clear All</a>
                        <button type="submit" class="btn btn-danger">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let taxSwitch = document.getElementById("flexSwitchCheckDefault");
        taxSwitch.addEventListener('click', () => {
            let taxInfoElements = document.getElementsByClassName("tax-info");
            for (let info of taxInfoElements) {
                if (info.style.display !== "inline") {
                    info.style.display = "inline";
                } else {
                    info.style.display = "none";
                }
            }
        });
    </script>